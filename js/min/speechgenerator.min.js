function didntGetStream(){alert("Stream generation failed. Please try Refreshing the page.")}function gotStream(e){var t=audioContext.createMediaStreamSource(e);meter=createAudioMeter(audioContext),t.connect(meter),drawLoop(),calcAverage()}function drawLoop(){meterCanvas.clearRect(0,0,WIDTH,HEIGHT),averageCanvas.clearRect(0,0,WIDTH,HEIGHT),meterCanvas.fillStyle=meter.checkClipping()?"red":"#E80C76",averageCanvas.fillStyle="#00FF3D",meterCanvas.fillRect(0,0,meter.volume*WIDTH*1.4,HEIGHT),averageCanvas.fillRect(0,0,averageVolume*WIDTH*1.4,HEIGHT),rafID=window.requestAnimationFrame(drawLoop)}function createAudioMeter(e,t,r,n){var a=e.createScriptProcessor(512);return a.onaudioprocess=volumeAudioProcess,a.clipping=!1,a.lastClip=0,a.volume=0,a.clipLevel=t||.98,a.averaging=r||.95,a.clipLag=n||750,a.connect(e.destination),a.checkClipping=function(){return this.clipping?(this.lastClip+this.clipLag<window.performance.now()&&(this.clipping=!1),this.clipping):!1},a.shutdown=function(){this.disconnect(),this.onaudioprocess=null},a}function volumeAudioProcess(e){for(var t,r=e.inputBuffer.getChannelData(0),n=r.length,a=0,o=0;n>o;o++)t=r[o],Math.abs(t)>=this.clipLevel&&(this.clipping=!0,this.lastClip=window.performance.now()),a+=t*t;var i=Math.sqrt(a/n);this.volume=Math.max(i,this.volume*this.averaging),volumeArrayLength>volumeArrayPosition?(volumeArray[volumeArrayPosition]=this.volume,volumeArrayPosition++):(volumeArrayPosition=0,volumeArray[volumeArrayPosition]=this.volume)}function generateText(e){var t=level;output[e]="",currentString=sourceFile[e],console.log("input string: "+currentString),nChars=currentString.length,currentString=currentString+" "+currentString,t>nChars&&(t=nChars),ichar=0,chr=currentString.charAt(ichar),output[e]=output[e]+currentString.substring(ichar,ichar+t),target=currentString.substring(ichar+1,ichar+t);for(var r=0;r<sourceFile[e].length-t;r++){if(1==t)chr=currentString.charAt(Math.floor(nChars*Math.random()));else{for(nmatches=0,j=-1;;){if(j=currentString.indexOf(target,j+1),0>j||j>=nChars)break;nmatches++}for(imatch=Math.floor(nmatches*Math.random()),nmatches=0,j=-1;;){if(j=currentString.indexOf(target,j+1),0>j||j>=nChars)break;if(imatch==nmatches){chr=currentString.charAt(j+t-1);break}nmatches++}}output[e]=output[e]+chr,t>1&&(target=target.substring(1,t-1)+chr)}}function calcAverage(){setTimeout(function(){for(var e=volumeArray.length,t=parseFloat(aValue.value),r=0,n=0;e>n;n++)r+=volumeArray[n];averageVolume=r/e,r=0,level=Math.ceil(t/averageVolume),document.getElementById("nlevel").innerHTML="Current Level: "+level,calcAverage()},100)}function loadVoices(){var e=speechSynthesis.getVoices();e.forEach(function(e){var t=document.createElement("option");t.value=e.name,t.innerHTML=e.name,voiceSelect.appendChild(t)})}function speak(e){msg=new SpeechSynthesisUtterance,msg.text=e,outputDiv.innerHTML+="<p>"+e+"</p>",outputDiv.scrollTop=outputDiv.scrollHeight,msg.volume=parseFloat(volumeInput.value),msg.rate=parseFloat(rateInput.value),msg.pitch=parseFloat(pitchInput.value),voiceSelect.value&&(msg.voice=speechSynthesis.getVoices().filter(function(e){return e.name==voiceSelect.value})[0]),window.speechSynthesis.speak(msg),phraseNo<sourceFile.length-1&&(msg.onend=function(){setTimeout(function(){phraseNo++,generateText(phraseNo),speak(output[phraseNo])},200)})}var audioContext=null,meter=null,meterCanvas=null,averageCanvas=null,WIDTH=500,HEIGHT=10,rafID=null,volumeArray=[],volumeArrayLength=1e3,volumeArrayPosition=0,averageVolume=0,level=100,aValue=document.getElementById("avalue"),sourceFile,currentString,nChars,iChar,chr,target,output=[],nmatches,imatch,j,phraseNo=0,outputDiv=document.getElementById("outputtext"),msg,voiceSelect=document.getElementById("voice"),volumeInput=document.getElementById("volume"),rateInput=document.getElementById("rate"),pitchInput=document.getElementById("pitch");window.onload=function(){sourceFile=aliceInWonderland.split(/,|\.|!|\?|;|:/);for(var e=0;e<sourceFile.length;e++)sourceFile[e]=sourceFile[e].replace(/'/g,""),sourceFile[e]=sourceFile[e].trim();console.log(sourceFile),generateText(0),meterCanvas=document.getElementById("meter").getContext("2d"),averageCanvas=document.getElementById("average").getContext("2d"),window.AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext;for(var e;volumeArrayLength>e;e++)volumeArray.push(.001);try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:!0},gotStream,didntGetStream)}catch(t){alert("getUserMedia threw exception :"+t)}},loadVoices(),window.speechSynthesis.onvoiceschanged=function(){loadVoices()};